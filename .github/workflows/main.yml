  name: build and deploy tradestore
  on:
    workflow_dispatch:   # run manually
    push:
      branches:
        - main

  jobs:
    build-deploy:
      name: build and deploy tradestore
      runs-on: ubuntu-20.04
          
      steps:
      
        - name: Checkout repository
          uses: actions/checkout@v4
          
        - name: Set up KinD (Kubernetes in Docker)
          uses: helm/kind-action@v1
          with:
            cluster_name: kafka-cluster
        
        - name: Create namespace
          run: kubectl create namespace kafka || true
        
        - name: Deploy Postgres
          run: kubectl apply -f postgres.yaml -n kafka
          
        - name: Apply Kafka + MongoDB
          run: kubectl apply -f kafka-kraft-mongodb.yaml -n kafka
        
        - name: checkout code
          uses: actions/checkout@v3

        - name: setup jdk 21
          uses: actions/setup-java@v3
          with:
            distribution: 'corretto'
            java-version: 21

        - name: unit tests
          run: mvn -B test --file pom.xml

        - name: build the apps
          run: mvn clean package
            
        - name: build the docker image for Tradestore
          uses: docker/build-push-action@v4
          with:
            context: .
            dockerfile: Dockerfile
            push: false
            tags: ${{ secrets.DOCKER_HUB_USERNAME }}/tradestore:latest
        
        - name: build the docker image for Tradestorescheduler
          uses: docker/build-push-action@v4
          with:
            context: .
            dockerfile: Dockerfile
            push: false
            tags: ${{ secrets.DOCKER_HUB_USERNAME }}/tradestorescheduler:latest

        - name: login to docker hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_HUB_USERNAME }}
            password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

        - name: push the docker image to docker hub for Tradestore
          uses: docker/build-push-action@v4
          with:
            context: .
            dockerfile: Dockerfile
            push: true
            tags: ${{ secrets.DOCKER_HUB_USERNAME }}/tradestore:latest
            
        - name: push the docker image to docker hub for Tradestorescheduler
          uses: docker/build-push-action@v4
          with:
            context: .
            dockerfile: Dockerfile
            push: true
            tags: ${{ secrets.DOCKER_HUB_USERNAME }}/tradestorescheduler:latest
